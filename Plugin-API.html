<html lang="en">

<head>
    
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Waylay.io Documentation</title>

    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/jquery-ui.css" rel="stylesheet">
    <link href="css/jquery.tocify.css" rel="stylesheet">
    <link href="css/prettify.css" type="text/css" rel="stylesheet" />
        <link href="css/freelancer.css" rel="stylesheet">
    
    <link rel="icon" type="image/png" href="http://www.waylay.io/favicon.png">
    </head>

    <body id="page-top" class="index">
        
        
    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-fixed-top" style="padding: 0;">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
<!--                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>-->
                <a class="navbar-brand" href="http://docs.waylay.io/">docs.waylay.io</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div id="navigation">
                <ul class="nav navbar-nav navbar-right">
                    <li class="page-scroll selected">
                    <a href="#">Please select</a>
                    </li>
                    <li class="page-scroll">
                        <a href="Waylay-REST-API-documentation.html">REST API</a>
                    </li>
                    <li class="page-scroll">
                        <a href="Plugin-API.html">Sensors & Actuators</a>
                    </li>
                    <li class="page-scroll">
                        <a href="Submitting-and-fetching-data.html">Broker & Storage</a>
                    </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container-fluid -->
    </nav>
        
        
        
        
        
        
        <div class="container-fluid">
        <div class="row-fluid" style="margin-top: 60px;">
        <div class="col-sm-3" style=" padding-left: 0; margin-left: -15px;">
        <div id="toc" class="tocify"></div>
        
        </div>
            <div class="col-sm-9"><h1 id="plugin-api-documentation">Plugin API documentation</h1>
<p>waylay has developed a cloud-based agent architecture that observes its environment via <strong>software-defined sensors</strong> and acts on its environment through <strong>software-defined actuators</strong>. A (very) high level blog about it you can find in this <a href="http://www.waylay.io/when-iot-meets-artificial-intelligence">blog</a></p>
<p>In short, if you implement a weather sensor, it should return a state such as “Rain” or “Sunny”, but it can as well provide information (rawData) such as temperature, humidity etc. Every sensor must either return <strong>state</strong> or <strong>rawData</strong> (it can also return both). Obviously, in order to execute a sensor, you will need some input, like <em>city</em>. How to declare what you need in the plug, and how the framework will provide this input to the sensor will be explained later in the document.</p>
<p>For the actuator implementation, there is no need to return any data, you just need to fire a script and that’s it, this can be an SMS, mail, tweet, REST call or any other thing.</p>
<p>Note: there is also possibility to write <strong>java based plugs, but this feature is only supported in OEM package</strong>. Java based plugs can be of your interest in case you want to write complex mathematical calculations which can’t be handled by the Functional node (described further in the document). For more information how to write such plugs, please e-mail to info@waylay.io</p>
<h1 id="webscripts">Webscripts</h1>
<p>Webscripts allow you to write plugins in JavaScript language. In the waylay webapp, you can start writing your own sensors and actuators. This is a sensor editor window that you get in the app:</p>
<div class="figure">
<img src="https://raw.githubusercontent.com/waylayio/documentation/master/images/sensorview.png" class="img-responsive"  alt="Sensor view" />
<p class="caption">Sensor view</p>
</div>
<p>If you start by clicking “Create Sensor”, you can see the following script created for you:</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">// sensors should never throw exceptions but instead send an error back</span>

<span class="kw">if</span>(<span class="ot">options</span>.<span class="ot">requiredProperties</span>.<span class="fu">testProperty1</span>) {
  <span class="kw">var</span> randomValue = <span class="ot">Math</span>.<span class="fu">random</span>();
  value = {
    <span class="dt">observedState</span>: randomValue &gt; <span class="fl">0.5</span> ? <span class="st">&quot;hello&quot;</span> : <span class="st">&quot;world&quot;</span>,
    <span class="dt">rawData</span>: {  <span class="dt">message</span>: <span class="st">&quot;message&quot;</span>, <span class="dt">x</span>: <span class="fl">2.34</span>, <span class="dt">random</span>: randomValue, <span class="dt">property</span>: <span class="ot">options</span>.<span class="ot">requiredProperties</span>.<span class="fu">testProperty1</span>}
  };
  <span class="fu">send</span>(<span class="kw">null</span>, value);
}<span class="kw">else</span>{
  <span class="fu">send</span>(<span class="kw">new</span> <span class="fu">Error</span>(<span class="st">&quot;Missing property testProperty1&quot;</span>));
}</code></pre>
<p>As you can see, this is just a simple JavaScript, nothing fancy. The only thing you need to know at this point is that these scripts will be executed by a node.js server, somewhere in the cloud. Every script is executed in a sandbox. Number of libraries are already provided to you and can simply access them from the script, no need to declare them. You have access to these (and only these) NPM packages:</p>
<ul>
<li>cheerio as cheerio,</li>
<li>request as request,</li>
<li>XMLHttpRequest as xhr,</li>
<li>google cloud messaging as gcm,</li>
<li>underscore as __, -note a double underscore</li>
<li>unirest as unirest,</li>
<li>twilio as twilio,</li>
<li>mysql as mysql,</li>
<li>mqtt as mqtt,</li>
<li>twitter as twitter,</li>
<li>console as console,</li>
<li>markup-js as Mark,</li>
<li>waylay util package as waylayUtil</li>
</ul>
<p>In case you need more libraries, let us now at support@waylay.io. Important thing to mention is that your script (both for sensors and actuators) MUST send back a value, regardless whether it was successful or not. So try to catch issues and send them back if you want. To send things back, call the method <em>send()</em>. If you call it without arguments, that is fine, but in case that this was a sensor, well then it is not that great. If you need a working example, just click new sensor or new actuator in the app and editor with default implementation will appear on the screen.</p>
<p>In case of a sensor implementation, you want to send back a result, so you must call a method <em>send(null, value)</em>, where value is a JSON object with:</p>
<ul>
<li>observedState (string)</li>
<li>rawData (JSON with key:value pairs) Note that if you want to send a valid response back, the fist argument <em>must</em> be a <em>null</em>, otherwise, the framework will treat a first argument as the error. In case you wonder why, well, let us just say that we try to be compatible to <a href="http://en.wikipedia.org/wiki/JSON-RPC">JSON-RPC spec</a></li>
</ul>
<p>For instance, let’s look at the following code:</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> randomValue = <span class="ot">Math</span>.<span class="fu">random</span>(); 
<span class="kw">var</span> state;
<span class="kw">if</span>(randomValue &gt; <span class="fl">0.85</span>)
  state = <span class="st">&quot;ONE&quot;</span>;
<span class="kw">else</span> <span class="kw">if</span>(randomValue &gt; <span class="fl">0.7</span>)
  state = <span class="st">&quot;TWO&quot;</span>;
<span class="kw">else</span> <span class="kw">if</span>(randomValue &gt; <span class="fl">0.55</span>)
  state = <span class="st">&quot;THREE&quot;</span>;
<span class="kw">else</span> <span class="kw">if</span>(randomValue &gt; <span class="fl">0.4</span>)
  state = <span class="st">&quot;FOUR&quot;</span>;
<span class="kw">else</span> <span class="kw">if</span>(randomValue &gt; <span class="fl">0.25</span>)
  state = <span class="st">&quot;FIVE&quot;</span>;
<span class="kw">else</span> 
  state = <span class="st">&quot;SIX&quot;</span>;
value = {  
    <span class="dt">observedState</span>:  state, 
    <span class="dt">rawData </span>: {  <span class="dt">random</span>: randomValue}  
}; 
<span class="fu">send</span>(<span class="kw">null</span>,value);</code></pre>
<p>Note that you <strong>always must return the value from the script</strong>! In this example, this sensor will roll the dice, return one of the six states, and also return a random value. Random value can later been access via the RAW Data context (see below). This sensor is also handy if you want to get familiar with boolean gates or if you want to test formula computation using a Function node.</p>
<p>Below you see an example of a result of a sensor invocation returned by the waylay webapp: <img src="https://raw.githubusercontent.com/waylayio/documentation/master/images/sensorResult.png" class="img-responsive"  /></p>
<p>If you want to send an error with errorMessage, just call <code>send(errorMessage)</code>.</p>
<h2 id="task-context">Task context</h2>
<p>Every webscript (both actuator and sensor) can access the following task context:</p>
<h3 id="properties">Properties</h3>
<p>These properties are normally provided to the script at configuration time. Typical examples of properties are URLs, API keys or connection settings. For instance, in the code you retrieve them like this:</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> url = <span class="ot">options</span>.<span class="ot">requiredProperties</span>.<span class="fu">url</span></code></pre>
<p>You are also required to provide this info in the metadata of the plug (right hand side of the editor), i.e. these Required Properties are not automatically parsed from the JavaScript.</p>
<h3 id="global-settings">Global settings</h3>
<p>You can also declare global settings which are available to sensors and actuators. These settings are visible in the profile page. This way you can for instance declare API keys that rarely change. When you define sensor or actuator, you can access these settings this way (where you need to replace the KEY with the exact key you have declared before):</p>
<p><code>options.globalSettings.KEY</code></p>
<p>for instance you can write a code that requires a token like this:</p>
<p><code>var token = options.requiredProperties.token || options.globalSettings.token</code></p>
<p>This way you can decide whether you want to provide a token at the time you start a task from a template, or you want to declare it in the global settings.</p>
<h3 id="raw-data">Raw Data</h3>
<p>Every plug can access raw data at runtime, even when that raw data was collected by another sensor. The only limitation is that you need to know the name of the node that you want to get the data from.</p>
<p>The raw data is provided in the form <code>options.rawData[node_name]</code> For instance, if you want to get a temperature of the node Home, you would need to get it like this:</p>
<pre><code>options.rawData.Home.temperature</code></pre>
<p>Now you can combine first two things together, so ask at configuration time a node name and then ask for temperature, by declaring that you need a node name in the Required Properties of the webscript:</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> temperature, nodeName = <span class="ot">options</span>.<span class="ot">requiredProperties</span>.<span class="fu">node</span>;
<span class="kw">if</span>(nodeName &amp;&amp; <span class="ot">options</span>.<span class="fu">rawData</span>[nodeName]){
  temperature = <span class="ot">options</span>.<span class="fu">rawData</span>[nodeName].<span class="fu">temperature</span>;
}</code></pre>
<p>Note: we will learn later how do the same with one liner, using waylay utility package.</p>
<h3 id="task-data">Task Data</h3>
<p>In the task context, you can retrieve the following task-related data:</p>
<ul>
<li>resource name (task resource name)</li>
<li>task ID (task ID)</li>
<li>node name (node name of the sensor to which this call is attached)</li>
</ul>
<p>In your plug code, you access these settings this way:</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="ot">options</span>.<span class="ot">task</span>.<span class="fu">RESOURCE</span>
<span class="ot">options</span>.<span class="ot">task</span>.<span class="fu">TASK_ID</span>
<span class="ot">options</span>.<span class="ot">task</span>.<span class="fu">NODE_NAME</span></code></pre>
<p>For instance, if you want to create an actuator that would control the running task (please see REST documentation for more info), this is how you can do it:</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> taskID = <span class="ot">options</span>.<span class="ot">requiredProperties</span>.<span class="fu">taskId</span> || <span class="ot">options</span>.<span class="ot">task</span>.<span class="fu">TASK_ID</span>;
<span class="kw">var</span> command = <span class="ot">options</span>.<span class="ot">requiredProperties</span>.<span class="fu">command</span>;
<span class="kw">var</span> username =  <span class="ot">options</span>.<span class="ot">globalSettings</span>.<span class="fu">API_KEY</span>;
<span class="kw">var</span> password = <span class="ot">options</span>.<span class="ot">globalSettings</span>.<span class="fu">API_PASS</span>;

<span class="ot">request</span>.<span class="fu">post</span>(
    <span class="st">&#39;https://&#39;</span>+ username + <span class="st">&#39;:&#39;</span> + password +<span class="st">&#39;@app.waylay.io/api/tasks/&#39;</span>+taskID+<span class="st">&#39;/command/&#39;</span>+command,
    <span class="kw">function</span> (error, response, body) {
        <span class="kw">if</span> (!error &amp;&amp; <span class="ot">response</span>.<span class="fu">statusCode</span> == <span class="dv">200</span>) {
            <span class="fu">send</span>();
        } <span class="kw">else</span>
            <span class="fu">send</span>(<span class="kw">new</span> <span class="fu">Error</span>(<span class="st">&quot;Error executing the action&quot;</span>));
    }
);</code></pre>
<p>Note that this way you can call any REST waylay call. The script above will either start or stop a task (command input), while the task ID can either come from the input param, or if not provided, it will act on the current task. This way, for instance, you can stop the task when a particular condition is met.</p>
<h3 id="actuator-data">Actuator Data</h3>
<p>Similar to raw data context, an actuator also can push some (limited) results back to the context. This is <em>not ideal</em>, but in case you need this, let me directly show you the code of one possible actuator implementation, that is only sending JSON object:</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="fu">send</span>(<span class="kw">null</span>, {<span class="dt">message</span>: <span class="st">&quot;hello world&quot;</span>});</code></pre>
<p>Notice that I was sending back value with a message. Normally, actuators are “fire and forget” by calling only <em>send()</em> , but this one is sending back a value - attaching the result in the context to the node to which this actuator belongs!</p>
<p>Later, you might want to do restore with this backup file:</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> nodeName = <span class="ot">options</span>.<span class="ot">requiredProperties</span>.<span class="fu">node</span>;
<span class="kw">if</span>(!<span class="ot">options</span>.<span class="fu">actuatorData</span> || !<span class="ot">options</span>.<span class="fu">actuatorData</span>[nodeName]){
    <span class="ot">console</span>.<span class="fu">info</span>(<span class="st">&quot;nothing to do&quot;</span>);
    <span class="fu">send</span>();
}
<span class="kw">else</span>{
    <span class="kw">var</span> value = <span class="ot">options</span>.<span class="fu">actuatorData</span>[nodeName].<span class="fu">message</span>; 
    <span class="co">/*you get back &quot;hello world&quot; </span>
<span class="co">    .... your code goes here */</span>
    <span class="fu">send</span>();
}</code></pre>
<h3 id="node-data">Node data</h3>
<p>You can also access the current state and the last execution time of the sensor:</p>
<ul>
<li><code>options.rawData[&lt;nodeName&gt;].state</code> and</li>
<li><code>options.rawData[&lt;nodeName&gt;].collectedTime</code> (in mills)</li>
</ul>
<p>This is useful in case you want for instance to do a sequence computation on the states of the nodes, for more info, see later section on this.</p>
<h3 id="utility-functions">Utility functions</h3>
<p>The name of the package is <strong>waylayUtil</strong>. This package provides 4 types of utility functions:</p>
<h4 id="functions-to-retrieve-raw-data">functions to retrieve raw data:</h4>
<p><code>var rawData =  waylayUtil.getRawData(options, &quot;nodeName&quot;);</code> to retrieve rawData as JSON for a node “nodeName” <code>var param =  waylayUtil.getRawData(options, &quot;nodeName&quot;, &quot;parameterName&quot;);</code> to retrieve parameter “parameterName” from rawData for node “nodeName”.</p>
<h4 id="functions-to-retrieve-cached-raw-data">functions to retrieve cached raw data:</h4>
<p><code>var rawData =  waylayUtil.getCacheData(options, &quot;latitude&quot;);</code> to retrieve parameter “latitude” from rawData of the node that invoke the script. This way you can for instance cache things that you need to retrieve only once (like location API).</p>
<p>For instance: you want to fetch geo location for a given address via the API service. Once the call is successful, in the result you can provide as the raw data “latitude” and “longitude”. Next time, these values will be automatically in the rawData of that node, so by simply calling <code>waylayUtil.getCacheData</code> on both parameters will give you this information, avoiding a need to call REST call again.</p>
<h4 id="function-to-evaluate-inputs-in-similar-way-this-is-done-for-function-node">function to evaluate inputs in similar way this is done for Function node:</h4>
<p><code>var rawValue =  waylayUtil.evaluateData(options, input);</code> where input is in format:</p>
<p><code>&lt;node1.rawdat1&gt; or &lt;node1.rawdat1&gt; OPER &lt;node2.rawdat2&gt;</code> … The only difference is that you can’t make statistical computations like with a Function node.</p>
<p>This way, for instance, you can use data that comes from another sensor (make sure that you use the sequence option if the order of execution is important). Another thing you must keep in mind is that you can access any raw data from the node as well as its state. If you want to test this feature, without creating a template, you can always try something like this (in the sensor editor):</p>
<pre><code>options.rawData = {
  &quot;hello&quot; : 
  {   randomValue: 5,
      state: &quot;True&quot;
  },
  &quot;world&quot; : 
  {   randomValue: 2,
      state: &quot;True&quot;
  }
};
console.log(&quot;rawData sensor&quot;);
if(options.requiredProperties.formula) {
    try{
      //console.log(options);
      var rawValue =  waylayUtil.evaluateData(options, options.requiredProperties.formula);
      var value = {
        observedState: options.requiredProperties.threshold &gt; rawValue ? &quot;Above&quot;: &quot;Below&quot;,
        rawData:  {  rawValue: rawValue}  
      };
      //console.log(&quot;value was &quot; + rawValue);
      send(null, value);
    } catch(err){
        send(new Error(err));
    }
} else{
  send(new Error(&quot;Missing property testProperty1&quot;));
}</code></pre>
<p>and for instance, you define a formula like this in the editor:</p>
<p><code>&lt;hello.randomValue&gt; - &lt;world.randomValue&gt;</code></p>
<p>Note: just make sure that once you are OK with a sensor, to <strong>comment this line <code>\\options.rawData = {</code></strong> , otherwise you will always overwrite the task context of the rawData in your sensor!</p>
<h4 id="distance-function">distance function</h4>
<p>You can use this function for nodes that have geo location in the raw data in format:</p>
<ul>
<li>longitude<br /></li>
<li>latitude.</li>
</ul>
<p>The easiest way to check this is by running a sensor and verifying rawData output after the execution.</p>
<p><code>var dist = waylayUtil.getDistance(options, &quot;nodeName1&quot;, &quot;nodeName2&quot;);</code></p>
<p>OR you can simply call the function this way, by providing all data yourself:</p>
<p><code>var dist = waylayUtil.getDistance(lat1, lon1, lat2, lon2);</code></p>
<h2 id="metadata">Metadata</h2>
<p>As part of a sensor/actuator plugin definition, you also need to provide metadata. For sensor plugins the following metadata needs to be defined:</p>
<ul>
<li><em>Name</em>: name of the sensor</li>
<li><em>Version</em>: three-digit version number.</li>
<li><em>Author</em>: author of the sensor.</li>
<li><em>Category</em>: sensors below to categories that group similar sensors. If the category does not exist yet, it will be created.</li>
<li><em>Documentation URL</em>: URL to external documentation for the sensor.</li>
<li><em>Icon URL</em>: URL to the icon that will be used in the webapp in combination with the sensor.</li>
<li><em>States</em>: define the states that the sensor can return to the node in your logic.</li>
<li><em>Properties</em>: inputs required to invoke the sensor.</li>
<li><em>Raw data</em>: raw data returned by the sensor.</li>
<li><em>Description</em>: Description of the sensor.</li>
</ul>
<p>For actuator plugins, the following metadata needs to be defined:</p>
<ul>
<li><em>Name</em>: name of the actuator</li>
<li><em>Version</em>: three-digit version number.</li>
<li><em>Author</em>: author of the actuator.</li>
<li><em>Category</em>: actuators below to categories that group similar actuators. If the category does not exist yet, it will be created.</li>
<li><em>Documentation URL</em>: URL to external documentation for the actuator.</li>
<li><em>Icon URL</em>: URL to the icon that will be used in the webapp in combination with the actuator.</li>
<li><em>Properties</em>: inputs required to invoke the actuator.</li>
<li><em>Description</em>: Description of the actuator.</li>
</ul>
<p>These metadata of the sensors and actuators are also exposed over the REST interface.</p>
<p>For instance, this is a REST response of one sensor:</p>
<pre class="sourceCode json"><code class="sourceCode json">    <span class="fu">{</span><span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;StockPrice&quot;</span><span class="fu">,</span>
        <span class="dt">&quot;description&quot;</span><span class="fu">:</span> <span class="st">&quot;Stock exchange sensor, stock price value&quot;</span><span class="fu">,</span>
        <span class="dt">&quot;author&quot;</span><span class="fu">:</span> <span class="st">&quot;Veselin&quot;</span><span class="fu">,</span>
        <span class="dt">&quot;version&quot;</span><span class="fu">:</span> <span class="st">&quot;1.0.1&quot;</span><span class="fu">,</span>
        <span class="dt">&quot;iconURL&quot;</span><span class="fu">:</span> <span class="st">&quot;http://app.waylay.io/icons/stock.png&quot;</span><span class="fu">,</span>
        <span class="dt">&quot;documentationURL&quot;</span><span class="fu">:</span> <span class="st">&quot;&quot;</span><span class="fu">,</span>
        <span class="dt">&quot;category&quot;</span><span class="fu">:</span> <span class="st">&quot;Stock&quot;</span><span class="fu">,</span>
        <span class="dt">&quot;states&quot;</span><span class="fu">:</span> <span class="ot">[</span>
            <span class="st">&quot;Below&quot;</span><span class="ot">,</span>
            <span class="st">&quot;Above&quot;</span>
        <span class="ot">]</span><span class="fu">,</span>
        <span class="dt">&quot;configuration&quot;</span><span class="fu">:</span> <span class="ot">[</span>
            <span class="fu">{</span>
                <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;threshold&quot;</span><span class="fu">,</span>
                <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;DOUBLE&quot;</span><span class="fu">,</span>
                <span class="dt">&quot;mandatory&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span>
                <span class="dt">&quot;sensitive&quot;</span><span class="fu">:</span> <span class="kw">false</span>
            <span class="fu">}</span><span class="ot">,</span>
            <span class="fu">{</span>
                <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;stock&quot;</span><span class="fu">,</span>
                <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;STRING&quot;</span><span class="fu">,</span>
                <span class="dt">&quot;mandatory&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span>
                <span class="dt">&quot;sensitive&quot;</span><span class="fu">:</span> <span class="kw">false</span>
            <span class="fu">}</span>
        <span class="ot">]</span>
        <span class="st">&quot;rawData&quot;</span><span class="er">:</span> <span class="ot">[</span>
            <span class="fu">{</span>
                <span class="dt">&quot;parameter&quot;</span><span class="fu">:</span> <span class="st">&quot;volume&quot;</span><span class="fu">,</span>
                <span class="dt">&quot;dataType&quot;</span><span class="fu">:</span> <span class="st">&quot;double&quot;</span><span class="fu">,</span>
                <span class="dt">&quot;collectedType&quot;</span><span class="fu">:</span> <span class="st">&quot;instant&quot;</span><span class="fu">,</span>
                <span class="dt">&quot;unit&quot;</span><span class="fu">:</span> <span class="st">&quot;double&quot;</span><span class="fu">,</span>
                <span class="dt">&quot;isObject&quot;</span><span class="fu">:</span> <span class="kw">true</span>
            <span class="fu">}</span><span class="ot">,</span>
            <span class="fu">{</span>
                <span class="dt">&quot;parameter&quot;</span><span class="fu">:</span> <span class="st">&quot;high&quot;</span><span class="fu">,</span>
                <span class="dt">&quot;dataType&quot;</span><span class="fu">:</span> <span class="st">&quot;double&quot;</span><span class="fu">,</span>
                <span class="dt">&quot;collectedType&quot;</span><span class="fu">:</span> <span class="st">&quot;instant&quot;</span><span class="fu">,</span>
                <span class="dt">&quot;unit&quot;</span><span class="fu">:</span> <span class="st">&quot;double&quot;</span><span class="fu">,</span>
                <span class="dt">&quot;isObject&quot;</span><span class="fu">:</span> <span class="kw">true</span>
            <span class="fu">}</span><span class="ot">,</span>
            <span class="fu">{</span>
                <span class="dt">&quot;parameter&quot;</span><span class="fu">:</span> <span class="st">&quot;low&quot;</span><span class="fu">,</span>
                <span class="dt">&quot;dataType&quot;</span><span class="fu">:</span> <span class="st">&quot;double&quot;</span><span class="fu">,</span>
                <span class="dt">&quot;collectedType&quot;</span><span class="fu">:</span> <span class="st">&quot;instant&quot;</span><span class="fu">,</span>
                <span class="dt">&quot;unit&quot;</span><span class="fu">:</span> <span class="st">&quot;double&quot;</span><span class="fu">,</span>
                <span class="dt">&quot;isObject&quot;</span><span class="fu">:</span> <span class="kw">true</span>
            <span class="fu">}</span><span class="ot">,</span>
            <span class="fu">{</span>
                <span class="dt">&quot;parameter&quot;</span><span class="fu">:</span> <span class="st">&quot;price&quot;</span><span class="fu">,</span>
                <span class="dt">&quot;dataType&quot;</span><span class="fu">:</span> <span class="st">&quot;double&quot;</span><span class="fu">,</span>
                <span class="dt">&quot;collectedType&quot;</span><span class="fu">:</span> <span class="st">&quot;instant&quot;</span><span class="fu">,</span>
                <span class="dt">&quot;unit&quot;</span><span class="fu">:</span> <span class="st">&quot;double&quot;</span><span class="fu">,</span>
                <span class="dt">&quot;isObject&quot;</span><span class="fu">:</span> <span class="kw">true</span>
            <span class="fu">}</span><span class="ot">,</span>
            <span class="fu">{</span>
                <span class="dt">&quot;parameter&quot;</span><span class="fu">:</span> <span class="st">&quot;moving_average&quot;</span><span class="fu">,</span>
                <span class="dt">&quot;dataType&quot;</span><span class="fu">:</span> <span class="st">&quot;double&quot;</span><span class="fu">,</span>
                <span class="dt">&quot;collectedType&quot;</span><span class="fu">:</span> <span class="st">&quot;computed&quot;</span><span class="fu">,</span>
                <span class="dt">&quot;unit&quot;</span><span class="fu">:</span> <span class="st">&quot;double&quot;</span><span class="fu">,</span>
                <span class="dt">&quot;isObject&quot;</span><span class="fu">:</span> <span class="kw">true</span>
            <span class="fu">}</span><span class="ot">,</span>
            <span class="fu">{</span>
                <span class="dt">&quot;parameter&quot;</span><span class="fu">:</span> <span class="st">&quot;percent&quot;</span><span class="fu">,</span>
                <span class="dt">&quot;dataType&quot;</span><span class="fu">:</span> <span class="st">&quot;double&quot;</span><span class="fu">,</span>
                <span class="dt">&quot;collectedType&quot;</span><span class="fu">:</span> <span class="st">&quot;instant&quot;</span><span class="fu">,</span>
                <span class="dt">&quot;unit&quot;</span><span class="fu">:</span> <span class="st">&quot;double&quot;</span><span class="fu">,</span>
                <span class="dt">&quot;isObject&quot;</span><span class="fu">:</span> <span class="kw">true</span>
            <span class="fu">}</span>
        <span class="ot">]</span>
    <span class="fu">}</span></code></pre>
<h1 id="function-node">Function node</h1>
<p>The Function node operates on the raw data that is stored in the task context.</p>
<h2 id="function-computation">Function computation</h2>
<p>If you have correctly created the metadata file of your sensor plugin, then the function editor will autocomplete the raw data that it can use for calculation. In case you have not defined the raw data as part of the sensor metadata, you will need to type everything manually. The screenshot below shows the autocompletion: <img src="https://raw.githubusercontent.com/waylayio/documentation/master/images/formulaEditor.png" class="img-responsive"  /></p>
<p>The function processing has a number of built-in capabilities that are described below:</p>
<h2 id="built-in-functions">Built-in functions</h2>
<p>You can fetch the raw data from any node this way: <code>&lt;node.value1&gt;</code>. That allows you to do something like this: <code>abs( &lt;node.value1&gt; - &lt;node.value2&gt;)</code></p>
<p>You can use all built in functions available in exp4j: <a href="http://www.objecthunter.net/exp4j/#Built-in_functions">Exp4j syntax</a></p>
<p>Built-in functions:</p>
<ul>
<li>abs: absolute value</li>
<li>acos: arc cosine</li>
<li>asin: arc sine</li>
<li>atan: arc tangent</li>
<li>cbrt: cubic root</li>
<li>ceil: nearest upper integer</li>
<li>cos: cosine</li>
<li>cosh: hyperbolic cosine</li>
<li>exp: euler’s number raised to the power (e^x)</li>
<li>floor: nearest lower integer</li>
<li>log: logarithmus naturalis (base e)</li>
<li>log10: logarithm (base 10)</li>
<li>log2: logarithm (base 2)</li>
<li>sin: sine</li>
<li>sinh: hyperbolic sine</li>
<li>sqrt: square root</li>
<li>tan: tangent</li>
<li>tanh: hyperbolic tangent</li>
</ul>
<p>When raw data values are used in a function, arrows between their corresponding nodes and the function processing node will be auto-created by the waylay application: <img src="https://raw.githubusercontent.com/waylayio/documentation/master/images/formulaNodes.png" class="img-responsive"  /></p>
<p>Note that you should never try to connect sensors to the Function node, this is not going to work, just start typing the function in the Function node, that is all.</p>
<h2 id="using-previous-values">Using previous values</h2>
<p>You can also fetch the data from previous measurements using <code>[-n]</code> syntax:</p>
<p><code>&lt;node.value1&gt; - &lt;node.value1&gt;[-1]</code></p>
<p>In the example above <code>&lt;node.value1&gt;[-1]</code> means: the value of the raw data parameter <em>value1</em> at the previous invocation time.</p>
<h2 id="using-time-difference">Using time difference</h2>
<p>You can also use a delta in time between measurements in your function with <code>dt</code> like this:</p>
<p><code>abs( &lt;node.value1&gt; - &lt;node.value1&gt;[-1]) / dt</code> to get kind of first derivative computation</p>
<p><code>dt</code> is replaced by time delta between invocations in seconds</p>
<h2 id="statistical-computation">Statistical computation</h2>
<p>You can also use some extensions for statistics such as <code>min, max, avg, std, count</code> this way:</p>
<p><code>&lt;max(node.value1)&gt; - &lt;min(node.value1)&gt;</code></p>
<p><code>&lt;count(5, node.pressure)&gt;</code> or like string search:</p>
<p><code>&lt;count(Gent, node2.current_city)&gt;</code></p>
<ul>
<li>Statistics (avg, min, max, std) either takes 1 argument (value) or 3 arguments (number, [time/samples], value)</li>
<li>Count either takes 2 arguments(“searchKey”, value) or 4 arguments (“searchKey”, number, [time/samples], value)</li>
</ul>
<h2 id="aggregation-types">Aggregation types</h2>
<p>You have 3 types of aggregation:</p>
<ul>
<li>overall aggregation</li>
<li>by time</li>
<li>by number of samples</li>
</ul>
<p>You can also mix different types in one function like this:</p>
<p><code>&lt;max(3, minutes, node.value1)&gt; - &lt;min(5, samples, node2.value1)&gt;</code></p>
<p><code>&lt;max(3, samples, node.value1)&gt; - &lt;min(3, minutes, node2.value1)&gt;</code></p>
<p><code>&lt;count(5, 3, minutes, node.pressure)&gt;</code></p>
<p>You can also count the number of times a node was in a given state, for instance, the number of time a node was in the state “OK” for the last three samples:</p>
<p><code>&lt;count(OK, 3, samples, node.state)&gt;</code></p>
<p>Note: limitation is that you can’t mix different aggregation types(samples and time) for the same parameter. But you can use overall aggregation (without samples, or time) and combine it with one of other aggregation types(samples or time).</p>
<h2 id="distance-calculation">Distance calculation</h2>
<p>For any two nodes that return longitude and latitude via raw data, you can compute the distance using this function:</p>
<p><code>distance(node1,node2)</code></p>
<p>Distance is returned in km.</p>
<h2 id="sequence">Sequence</h2>
<p>You can also search for a sequence of states, if you want to monitor for changes of node states in time.</p>
<p><code>&lt;sequence([hello,world], node.state)&gt;</code></p>
<p>Function above will either return 1 or 0. 1 indicates that a match of the sequence has been found.</p>
<p>For instance, if you want to know whether 3 nodes will be in “hello,world” sequence, you can create function this way:</p>
<p><code>&lt;sequence([hello,world], node1.state)&gt;</code> + <code>&lt;sequence([hello,world], node2.state)&gt;</code> + <code>&lt;sequence([hello,world], node3.state)&gt;</code></p>
<p>and test whether the result equals 3.</p>
<h1 id="realtime-data">Realtime data</h1>
<p>The waylay application allows you to use runtime data that it is pushed to the task by resource name (see REST documentation for more information) .</p>
<p>In that case, you access the data via in javascript: <code>options.rawData.GLOBAL.&lt;param&gt;</code></p>
<p>where param is the runtime data that is pushed to the current task. You can also use this value in utility functions like any other raw data.</p>
<p>In the Function node, you MUST omit options.rawData and use this: <code>&lt;GLOBAL.param&gt;</code></p>
<p>Before deploying a new task, you can always check in the debug window that computation is actually happening. In the example below we used a dice sensor and couple of Function nodes. Note that you can as well put one Function node on top of others:</p>
<div class="figure">
<img src="https://raw.githubusercontent.com/waylayio/documentation/master/images/formulaDebug.png" class="img-responsive"  />

</div>
<a href="#" class="scrollup"><a href="http://docs.waylay.io/"></a></a>

</div>
        </div>
                </div>
     <footer class="text-center">

        <div class="footer-below">
            <div class="container">
                <div class="row">
                    <div class="col-xs-9 pull-right">
                        Copyright &copy; waylay.io 2015
                    </div>
                </div>
            </div>
        </div>
    </footer>
    <script src="js/jquery-1.11.2.min.js"></script>
    <script src="js/jquery-ui-1.9.1.custom.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/jquery.tocify.min.js"></script>
    <script src="js/prettify.js"></script>
    <script src="js/tinynav.min.js"></script>
    <script src="js/freelancer.js"></script>
</body>

</html>

